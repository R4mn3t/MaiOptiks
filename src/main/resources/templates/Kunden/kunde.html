<!DOCTYPE html>
<html lang="de" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org/">
<head>
	<meta charset="UTF-8">
	<title th:text="${title}"></title>
	<link rel="stylesheet" th:href="@{/css/main.css}"></link>
	<link rel="stylesheet" th:href="@{/css/startseite-style.css}"></link>
	<script th:src="@{/scripts/main.js}" type="text/javascript"></script>
	<script th:src="@{/scripts/table.js}" type="text/javascript"></script>
</head>
<body>
<div class="title-bar">
	<h1 class="heading">Kunde</h1>
</div>

<div class="vertical-bar">
	<p></p>
</div>

<div class="customerButton-searchField">
	<div class="customers">
		<button class="button customer-button" onclick="openLink('/auftrag')" type="button">Auftrag</button>
	</div>

	<div class="search-fields">
		<input class="input" id="lastname" placeholder="Name" type="text"></input><br>
		<input class="input" id="name" placeholder="Vorname" type="text"></input><br>
		<button class="button submit-button" onclick="searchCustomer()">Suchen</button>
	</div>
</div>

<div class="table-container" id="customerTable"></div>

<div class="direction-buttons">
	<button class="button direction-button" onclick="openLink('./')">Startseite</button>
	<button class="button direction-button" onclick="openLink('/neuer-kunde')">Neuer Kunde</button>
	<button class="button direction-button" onclick="openLink('/organisation')">Organisation</button>
	<button class="button direction-button" onclick="openLink('/führerscheinsehtest')">Führerschein-Sehtest</button>
	<button class="button direction-button" onclick="openLink('/mitarbeiter')">Mitarbeiter</button>
</div>

<nav class="contextMenu" id="contextMenu">
	<ul class="contextMenuItems">
		<li class="contextMenuItem" onclick="openLink('#')">
			<a href="#"
			   class="contextMenuLink"
			   data-action="change">Bearbeiten</a>
		</li>
		<hr/>
		<li class="contextMenuItem" onclick="openLink('/auftrag')">
			<a href="/auftrag"
			   class="contextMenuLink"
			   data-action="orders">Aufträge</a>
		</li>
	</ul>
</nav>
</body>
<script>
	document.getElementById('lastname').addEventListener('keyup', (e) => {
		if (e.key === 'Enter') {
			searchCustomer();
		}
	});

	document.getElementById('name').addEventListener('keyup', (e) => {
		if (e.key === 'Enter') {
			searchCustomer();
		}
	});

	function searchCustomer() {
		let name = document.getElementById('name').value;
		let lastname = document.getElementById('lastname').value;
		let tableContainer = 'customerTable';

		switch (true) {
			case (lastname === '' && name === ''):
				lastname = '*';
				name = '*';
				break;
			case (lastname === '' && name !== ''):
				lastname = '*';
				break;
			case (lastname !== '' && name === ''):
				name = '*';
				break;
		}

		let key = `?name=${lastname}&vorname=${name}`;

		doGetRequest(
			'/api/kundes',
			key,
			(data) => {   // func
				createTable(data, tableContainer, "neuer-kunde");
			});
	}

	////////////////
	// Kontext Menü
	////////////////
	const contextMenuClassName = 'contextMenu';
	const contextMenuItemClassName = 'contextMenuItem';
	const contextMenuLinkClassName = 'contextMenuLink';
	const menu = document.querySelector('#contextMenu');
	const contextMenuActive = 'contextMenu--active';
	const taskItemClassName = 'dataCell';
	let menuState = 0;
	let clickCoords;
	let clickCoordsX;
	let clickCoordsY;
	let menuWidth;
	let menuHeight;
	let windowWidth;
	let windowHeight;
	let taskItemInContext;

	// Rechtsklickevent & Standardmenü verhindern
	document.addEventListener('contextmenu', (evt) => {
		taskItemInContext = clickInsideElement(evt, taskItemClassName);

		if (taskItemInContext) {
			evt.preventDefault();
			toggleMenuOn();
			positionMenu(evt);
		} else {
			taskItemInContext = null;
			toggleMenuOff();
		}
	});

	// Menü anzeigen
	function toggleMenuOn() {
		if (menuState !== 1) {
			menuState = 1;
			menu.classList.add(contextMenuActive);
		}
	}

	// Menü ausblenden
	function toggleMenuOff() {
		if (menuState !== 0) {
			menuState = 0;
			menu.classList.remove(contextMenuActive);
		}
	}

	// Klick außerhalb der Tabelle?
	function clickInsideElement(elm, className) {
		elm = elm.target;

		if (elm.classList.contains(className)) {
			return elm;
		} else {
			while (elm === elm.parentNode) {
				if (elm.classList && elm.classList.contains(className)) {
					return elm;
				}
			}
		}

		return false;
	}

	// Kontext Menu an Position des Cursors verschieben
	function positionMenu(evt) {
		clickCoords = getPosition(evt);
		clickCoordsX = clickCoords.x + 'px';
		clickCoordsY = clickCoords.y + 'px';

		menu.style.left = clickCoordsX;
		menu.style.top = clickCoordsY;

		menuWidth = menu.offsetWidth;
		menuHeight = menu.offsetHeight;

		windowWidth = window.innerWidth;
		windowHeight = window.innerHeight;

		if ((windowWidth - clickCoordsX) < menuWidth) {
			menu.style.left = windowWidth - menuWidth + 'px';
		} else {
			menu.style.left = clickCoordsX + 'px';
		}

		if ((windowHeight - clickCoordsY) < menuHeight) {
			menu.style.top = windowHeight - menuHeight + 'px';
		} else {
			menu.style.top = clickCoordsY + 'px';
		}
	}

	// Position des Cursors beim Klick ermitteln
	function getPosition(evt) {
		let posX = 0;
		let posY = 0;

		if (!evt) evt = window.event;

		if (evt.pageX || evt.pageY) {
			posX = evt.pageX;
			posY = evt.pageY;
		} else if (evt.clientX || evt.clientY) {
			posX = evt.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
			posY = evt.clientY + document.body.scrollTop + document.documentElement.scrollTop;
		}

		return {x: posX, y: posY};
	}

	function menuItemListener(link) {
		debugger;
		console.log('TaskId: ' + taskItemInContext.getAttribute('id')
			+ 'Task action: ' + link.getAttribute('data-action'));
		toggleMenuOff();
	}

	// Linksklick zum Deaktivieren
	document.addEventListener('click', (evt) => {
		let clickElemIsLink = clickInsideElement(evt, contextMenuLinkClassName);

		if (clickElemIsLink) {
			evt.preventDefault();
			menuItemListener(clickElemIsLink);
		} else {
			let button = evt.button;

			if (button === 0) {
				toggleMenuOff();
			}
		}

	});

	// Escape zum Deaktivieren
	window.onkeyup = (evt) => {
		if (evt.key === 'Escape') {
			toggleMenuOff();
		}
	};

	// Fenstergröße verändert?
	window.onresize = () => {
		toggleMenuOff();
	}

	// Mausrad bedient?
	document.onscroll = () => {
		toggleMenuOff();
	}
</script>
</html>