<!DOCTYPE html>
<html lang="de" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <title th:text="${title}"></title>
    <link rel="stylesheet" th:href="@{/css/main.css}"></link>
    <link rel="stylesheet" th:href="@{/css/kundeNew-style.css}"></link>
    <script th:src="@{/scripts/main.js}" type="text/javascript"></script>
</head>
<body>
<div class="title-bar">
    <h1 class="heading">Kunde</h1>
</div>

<div class="vertical-bar">
    <p></p>
</div>

<div class="flexbox" style="background-color: red;">
    <table>
        <tr>
            <td><label for="customerNo">Kundennummer</label></td>
            <td><input id="customerNo" type="number"></td>
            <td><select>
                <option>Herr</option>
                <option>Frau</option>
                <option>Divers</option>
            </select></td>
        </tr>
        <tr>
            <td><label for="name">Vorname</label></td>
            <td colspan="2"><input id="name" type="text"></td>
        </tr>
        <tr>
            <td><label for="lastname">Nachname</label></td>
            <td colspan="2"><input id="lastname" type="text"></td>
        </tr>
    </table>
</div>

<hr>

<div class="flexbox" style="background-color: blue;">
    <table>
        <tr>
            <td><label for="street">Straße und Hausnummer</label></td>
            <td><input id="street" type="text"></td>
            <td><input id="houseNo"></td>
        </tr>
        <tr>
            <td><label for="place">Ort</label></td>
            <td colspan="2"><input id="place" type="text"></td>
        </tr>
        <tr>
            <td><label for="birthdate">Geburtsdatum</label></td>
            <td colspan="2"><input id="birthdate" type="date"></td>
        </tr>
        <tr>
            <td><label for="phoneNo">Telefonnummer</label></td>
            <td colspan="2"><input id="phoneNo" type="number"></td>
        </tr>
        <tr>
            <td><label for="mobileNo">Handy</label></td>
            <td colspan="2"><input id="mobileNo" type="number"></td>
        </tr>
        <tr>
            <td><label for="email">Email</label></td>
            <td colspan="2"><input id="email" type="email"></td>
        </tr>
    </table>
</div>

<div class="flexbox" style="background-color: pink;">
    <table>
        <tr>
            <td><label for="health">Krankenkassennummer</label></td>
            <td><input id="health" type="number"></td>
        </tr>
        <tr>
            <td><label for="insurance">Versicherungsnummer</label></td>
            <td><input id="insurance" type="text"></td>
        </tr>
        <tr>
            <td><label for="valid">Gültigkeit</label></td>
            <td><input id="valid" type="date"></td>
        </tr>
        <tr>
            <td><label for="note">Bemerkung</label></td>
            <td><input id="note" type="text"></td>
        </tr>
    </table>
</div>

<div class="table-container"></div>

<div class="direction-buttons">
    <button class="button direction-button" onclick="openLink('./')">Startseite</button>
    <button class="button direction-button" onclick="openLink('/neuer-kunde')">Neuer Kunde</button>
    <button class="button direction-button" onclick="openLink('/organisation')">Organisation</button>
    <button class="button direction-button" onclick="openLink('/führerscheinsehtest')">Führerschein-Sehtest</button>
</div>

</body>
<script>
    document.getElementById('lastname').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            searchCustomer();
        }
    });

    document.getElementById('name').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            searchCustomer();
        }
    });

    function searchCustomer() {
        let name = document.getElementById('name').value;
        let lastname = document.getElementById('lastname').value;

        switch (true) {
            case (name === '' && lastname === '') :
                document.getElementById('name').style.border = '2px solid red';
                document.getElementById('lastname').style.border = '2px solid red';
                return;
            case (name === '' && lastname !== '') :
                document.getElementById('name').style.border = '2px solid red';
                document.getElementById('lastname').style.border = '1px solid black';
                return;
            case (lastname === '' && name !== '') :
                document.getElementById('lastname').style.border = '2px solid red';
                document.getElementById('name').style.border = '1px solid black';
                return;
            case (lastname !== '' && name !== '') :
                document.getElementById('name').style.border = '1px solid black';
                document.getElementById('lastname').style.border = '1px solid black';
                name = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
                lastname = lastname.charAt(0).toUpperCase() + lastname.slice(1).toLowerCase();
                break;
        }

        doGetRequest(
            '/api/kundes/',
            (lastname !== '' && name !== '') ? (lastname + '/' + name) : undefined,
            (data) => {   // func
                createTable(data, lastname, name);
            });
    }

    function createTable(data, lastname, name) {
        // Bereits eine Tabelle vorhanden?
        if (document.getElementsByClassName('table-container')[0].firstElementChild !== null) {
            const entries = document.getElementsByTagName('TD');
            const existingRows = document.getElementsByTagName('TR');
            // Tabellen Daten identisch mit Eingabe?
            if (entries[2].innerHTML === lastname && entries[3].innerHTML === name) {
                return;
            }
            // Überflüssige Zeilen löschen
            if (data.length < (existingRows.length - 1) && existingRows.length > 2) {
                for (let r = (data.length + 1); r < existingRows.length; r++) {
                    document.getElementsByTagName('TR')[r].remove();
                }
            }
            // Wenn zu wenig Zeilen vorhanden Tabelle löschen und neu erstellen
            if (data.length > (existingRows.length - 1)) {
                document.getElementsByTagName('TABLE')[0].remove();
                createTable(data, lastname, name);
                return;
            }
            // Vorhandene Zeile durch neue Daten ersetzen
            for (let j = 0; j < data.length; j++) {
                for (let i = 0; i < entries.length; i++) {
                    const values = Object.values(data[j]);

                    entries[i].innerHTML = values[i];
                }
            }
        } else {
            const tableContainer = document.getElementsByClassName('table-container')[0];
            const table = document.createElement('TABLE');
            const tableHead = document.createElement('THEAD');
            const tableBody = document.createElement('TBODY');

            table.appendChild(tableHead);
            table.appendChild(tableBody);

            const headerRow = document.createElement('TR');
            const keys = Object.keys(data[0]);

            keys
                .map((item) => {
                    const th = document.createElement('TH');
                    const caps = item.charAt(0).toUpperCase() + item.slice(1);
                    th.innerHTML = caps.valueOf();
                    headerRow.appendChild(th);
                });
            // Für jeden Kunden neue Zeile erstellen
            for (let i = 0; i < data.length; i++) {
                const dataRow = document.createElement('TR');
                const values = Object.values(data[i]);

                values
                    .map((item) => {
                        const td = document.createElement('TD');
                        td.innerHTML = item.valueOf();
                        dataRow.appendChild(td);
                    });

                tableHead.appendChild(headerRow);
                tableBody.appendChild(dataRow)
            }

            tableContainer.appendChild(table);
        }

        let allRows = document.getElementsByTagName('TR');

        for (let i = 0; i < allRows.length; i++) {
            allRows[i].addEventListener('click', () => {
                window.location.href = '/auftrag'; // TODO: Link zu Kundenseite
            });
        }
    }
</script>
</html>